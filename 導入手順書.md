# 質疑応答連絡書 自動監視システム 導入手順書

## 📋 システム概要

本システムは、Googleスプレッドシートの質疑応答連絡書を自動監視し、新規質疑・回答の登録やデータ変更を検知して、Discord/メールに通知を送信するGoogle Apps Scriptです。

### 主要機能
- ✅ 新規質疑の自動検知と通知（A〜H列監視）
- ✅ 新規回答の自動検知と通知（I・J列監視）
- ✅ データの変更・削除の監視と通知
- ✅ スプレッドシートの自動バックアップ
- ✅ Discord Webhookとメール通知の両方に対応

---

## 🚀 導入手順

### 前提条件
- Googleアカウント
- 質疑応答連絡書のGoogleスプレッドシート
- Discord Webhook URL（Discord通知を使用する場合）
- Gmail送信権限（メール通知を使用する場合）

### ステップ1: スクリプトエディタを開く

1. 質疑応答連絡書のGoogleスプレッドシートを開く
2. メニューから **拡張機能** → **Apps Script** を選択
3. 新しいタブでスクリプトエディタが開きます

### ステップ2: コードを設置

1. エディタ内の既存コード（`myFunction()`など）を全て削除
2. `qa_monitoring.gs`の内容を全てコピー
3. スクリプトエディタに貼り付け
4. **Ctrl+S**（Mac: **Cmd+S**）で保存
5. プロジェクト名を「質疑応答監視システム」などに変更

### ステップ3: バックアップ用スプレッドシートの作成

1. Googleドライブで新しいスプレッドシートを作成
2. 名前を「質疑応答連絡書_バックアップ」などに変更
3. URLからスプレッドシートIDをコピー
   ```
   URL例: https://docs.google.com/spreadsheets/d/【ここがID】/edit
   ```

### ステップ4: Discord Webhookの設定（Discord通知を使用する場合）

1. Discordサーバーの設定を開く
2. **連携サービス** → **ウェブフック** を選択
3. **新しいウェブフック**を作成
4. **ウェブフックURLをコピー**をクリック
5. 安全な場所に保存

### ステップ5: スクリプトプロパティの設定

1. スクリプトエディタで以下の関数を実行
   - 実行ボタンの横のドロップダウンから`setupScriptProperties`を選択
   - **実行**ボタンをクリック

2. 初回実行時の権限承認
   - 「承認が必要です」と表示されたら**権限を確認**
   - Googleアカウントを選択
   - 「このアプリは確認されていません」と表示されたら**詳細**をクリック
   - **質疑応答監視システム（安全ではないページ）に移動**をクリック
   - **許可**をクリック

3. プロパティを編集
   - エディタ左側の歯車アイコン（プロジェクトの設定）をクリック
   - 下部の**スクリプト プロパティ**セクションを確認
   - **スクリプト プロパティを編集**をクリック
   - 以下の値を設定：

```javascript
// プロパティ設定例
DISCORD_WEBHOOKS: https://discord.com/api/webhooks/xxx/yyy,https://discord.com/api/webhooks/aaa/bbb
EMAIL_ADDRESSES: admin@example.com,manager@example.com
BACKUP_SHEET_ID: 1234567890abcdefghijk
PROCESSED_QUESTIONS: []
PROCESSED_ANSWERS: []
LAST_DATA_HASH:
```

### ステップ6: 時間ベーストリガーの設定

1. `setupTimeTrigger`関数を選択
2. **実行**ボタンをクリック
3. 「時間ベーストリガーを設定しました」のログを確認

### ステップ7: 動作確認

1. `testRun`関数を選択
2. **実行**ボタンをクリック
3. テストデータを入力：
   - スプレッドシートにテスト質疑を入力（A〜H列）
   - 再度`testRun`を実行
   - Discord/メールに通知が届くことを確認

---

## ⚙️ 設定値の詳細

### Discord Webhooks
- **形式**: カンマ区切りで複数設定可能
- **例**:
  ```
  https://discord.com/api/webhooks/1234567890/abcdefghijk
  ```
- **複数設定例**:
  ```
  https://discord.com/api/webhooks/xxx/yyy,https://discord.com/api/webhooks/aaa/bbb
  ```

### メールアドレス
- **形式**: カンマ区切りで複数設定可能
- **例**:
  ```
  project-manager@example.com
  ```
- **複数設定例**:
  ```
  admin@example.com,manager@example.com,team@example.com
  ```

### バックアップシートID
- **取得方法**: スプレッドシートURLの`/d/`と`/edit`の間の文字列
- **例**:
  ```
  URL: https://docs.google.com/spreadsheets/d/1a2b3c4d5e6f7g8h9i0j/edit
  ID: 1a2b3c4d5e6f7g8h9i0j
  ```

---

## 🔧 カスタマイズ

### 監視間隔の変更

デフォルトは1時間ごとですが、変更可能です：

```javascript
// 30分ごとに変更する場合
ScriptApp.newTrigger('monitorQASheet')
  .timeBased()
  .everyMinutes(30)  // ← ここを変更
  .create();
```

### 通知フォーマットの変更

各フォーマット関数で表示形式をカスタマイズできます：
- `formatQuestionsForDiscord()` - Discord質疑通知
- `formatAnswersForDiscord()` - Discord回答通知
- `generateQuestionEmailContent()` - メール質疑通知
- `generateAnswerEmailContent()` - メール回答通知

---

## 🔍 トラブルシューティング

### 問題: 通知が届かない

**確認事項:**
1. スクリプトプロパティの設定値を確認
   - Discord Webhook URLが正しいか
   - メールアドレスが正しいか
2. トリガーが設定されているか確認
   - エディタの時計アイコン → トリガー一覧
3. 実行ログを確認
   - エディタの実行数アイコン → 実行履歴

### 問題: 「承認が必要です」エラー

**解決方法:**
1. 関数を手動実行
2. 権限承認ダイアログで許可
3. Googleアカウントの設定で「安全性の低いアプリ」を許可

### 問題: 重複通知が発生する

**解決方法:**
1. トリガーが重複していないか確認
2. `resetProcessedLists()`を実行して処理済みリストをリセット

### 問題: バックアップが作成されない

**確認事項:**
1. バックアップシートIDが正しいか
2. バックアップシートへのアクセス権限があるか
3. エラーログを確認

### ログの確認方法

1. Apps Scriptエディタで**実行数**アイコンをクリック
2. 実行履歴から詳細を確認
3. エラーメッセージがある場合は内容を確認

---

## 📝 運用上の注意事項

### データ整合性
- スプレッドシートの列構成を変更しない
- A列（番号）は必ず一意の値を設定
- 処理済みリストは自動管理されるため手動変更不要

### パフォーマンス
- 大量データ（1000行以上）の場合は処理時間に注意
- 必要に応じて監視間隔を調整

### セキュリティ
- Discord Webhook URLは外部に漏らさない
- スクリプトプロパティへのアクセスを制限
- 定期的にWebhook URLを更新

### メンテナンス
- 月1回程度、実行ログを確認
- 不要な処理済みデータを定期的にクリア
- バックアップシートの容量を確認

---

## 🆘 サポート

### よくある質問

**Q: 通知の文字数制限は？**
- Discord: 2000文字（自動分割対応）
- メール: 制限なし（HTMLメール）

**Q: 複数のスプレッドシートを監視できる？**
- 各スプレッドシートごとに個別設定が必要

**Q: 通知を一時停止したい**
- トリガーを無効化または削除

### 関数リファレンス

| 関数名 | 説明 | 用途 |
|--------|------|------|
| `monitorQASheet()` | メイン監視処理 | トリガーで自動実行 |
| `testRun()` | テスト実行 | 手動での動作確認 |
| `setupScriptProperties()` | 初期設定 | 初回セットアップ時 |
| `setupTimeTrigger()` | トリガー設定 | 自動実行の設定 |
| `resetProcessedLists()` | リストリセット | 再監視が必要な時 |

---

## 📄 更新履歴

- **v1.0.0** (2024/09/23)
  - 初版リリース
  - 基本的な監視機能実装
  - Discord/メール通知対応
  - バックアップ機能追加

---

## 📋 チェックリスト

導入完了前の最終確認：

- [ ] スクリプトコードを貼り付けた
- [ ] バックアップ用スプレッドシートを作成した
- [ ] スクリプトプロパティを設定した
- [ ] Discord Webhook URLを設定した（使用する場合）
- [ ] メールアドレスを設定した（使用する場合）
- [ ] 権限承認を完了した
- [ ] トリガーを設定した
- [ ] テスト実行で通知を確認した
- [ ] 本番データで動作確認した

以上で導入は完了です。